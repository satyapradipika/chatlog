<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import React from "https://cdn.skypack.dev/react";
      import ReactDOM from "https://cdn.skypack.dev/react-dom";
      import htm from "https://cdn.skypack.dev/htm";
      import { Octokit } from "https://esm.sh/octokit";
      import axios from "https://cdn.skypack.dev/axios";
      (() => {
        const Index = () => {
          const html = htm.bind(React.createElement);
          const [octokit, setOctokit] = React.useState(null);
          const gistId = "d9835b9358da0e123f11b8bc462e168b";
          const [isRecording, setIsRecording] = React.useState(false);
          const [text, setText] = React.useState([]);
          const [entries, setEntries] = React.useState([]);
          const entriesRef = React.useRef(null);
          entriesRef.current = entries;

          React.useEffect(() => {
            (async () => {
              const payload = {
                encrypted_message:
                  "1512b85329feeb1b80d89bee7b444dc7e1543747d1bf7451c9ecb9323c1e2f6243b68917dab1045872bb63236bec59768f8eef837d318c44a48d7150c02394bd252e96bf5ce8dc11fd3305a4bf1383d0ea62187d211f5a24c7e0845c467e442bbc613bb1254b8f751b60c72e5056e66dc0117d4baf8ae1272b66e80192d9599876209f325af297f0dbb7a0d46a66c5a488a75ff24d917cc05ae76287cd75a9bceeee095e1fba29b21bfc5145e9367cf773e3fca940a5686ac710134ddce29d1536b54dd2337cbb25e1e3fdba21ab7f0a6bf3c0c4d5e6b95d9a43f651c22d3fd90008b3343fa0ac47973b1d6f680fd04d1a50c2d5bb93d068ff92a55605aa5a74",
              };
              const decryptEndpoint =
                "https://europe-west9-encrypt-decrypt-403217.cloudfunctions.net/decrypt-message";
              const response = await axios.post(decryptEndpoint, payload);
              setOctokit(
                new Octokit({
                  auth: response.data.decrypted_message,
                })
              );
            })();
          }, []);

          React.useEffect(() => {
            const SpeechRecognition =
              window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.onresult = (event) => {
              const lastIndex = event.results.length - 1;
              const transcript = event.results.item(lastIndex)[0].transcript;
              setText((text) => [...text, transcript]);
            };
            recognition.onaudioend = () => {
              recognition.abort();
              setIsRecording(false);
              setTimeout(function () {
                recognition.start();
                setIsRecording(true);
              }, 100);
            };
            recognition.start();
            setIsRecording(true);
            return () => {
              recognition.stop();
            };
          }, []);

          React.useEffect(() => {
            if (!octokit) return;
            if (entriesRef.current.length > 0) return;
            const polling = async () => {
              const gist = await getGist();
              const files = gist.data.files;
              for (const [key, value] of Object.entries(files).slice(-200)) {
                if (!entriesRef.current.some((entry) => entry.file === key)) {
                  setEntries((entries) => [
                    ...entries,
                    { file: key, content: value.content },
                  ]);
                }
              }
            };
            setInterval(polling, 15000);
            polling();
          }, [octokit]);

          React.useEffect(() => {
            (async () => {
              const message = text.pop();
              if (!message) return;
              const payload = { file: `${Date.now()}.txt`, content: message };
              setEntries((entries) => [...entries, payload]);
              const files = {
                [payload.file]: {
                  content: payload.content,
                },
              };
              await patchGist(files);
            })();
          }, [text]);

          const getGist = async () => {
            return await octokit.request("GET /gists/{gist_id}", {
              gist_id: gistId,
              headers: {
                "X-GitHub-Api-Version": "2022-11-28",
              },
            });
          };

          const patchGist = async (files) => {
            return await octokit.request("PATCH /gists/{gist_id}", {
              gist_id: gistId,
              description: "An updated gist description",
              files: files,
              headers: {
                "X-GitHub-Api-Version": "2022-11-28",
              },
            });
          };

          const removeFile = async (e) => {
            const filename = e.target.getAttribute("data-file");
            setEntries((entries) =>
              entries.filter((entry) => entry.file !== filename)
            );
            const files = {
              [filename]: null,
            };
            await patchGist(files);
          };

          return html`
            <section class="container mx-auto">
              <p class="text-right">
                Recording: ${isRecording ? "true" : "false"}
              </p>
              <ul>
                ${entries
                  .sort(
                    (a, b) =>
                      parseInt(b.file.split(".txt")[0]) -
                      parseInt(a.file.split(".txt")[0])
                  )
                  .map(
                    (entry, key) => html`
                      <li key=${key}>
                        <div className="grid grid-cols-12 p-6 border-2">
                          <p className="col-span-10 px-6">${entry.content}</p>
                          <div className="col-span-2">
                            <button
                              onClick=${removeFile}
                              data-file=${entry.file}
                              className="p-3 bg-red-500 text-white"
                            >
                              Remove
                            </button>
                            <p>
                              ${new Date(
                                parseInt(entry.file.split(".txt")[0])
                              ).toLocaleString()}
                            </p>
                          </div>
                        </div>
                      </li>
                    `
                  )}
              </ul>
            </section>
          `;
        };
        const container = document.getElementById("root");
        ReactDOM.render(React.createElement(Index), container);
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
